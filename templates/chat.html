{% extends "base.html" %}

{% block title %}ì‹¤ì‹œê°„ ì±„íŒ… - ìš°ë¦¬ë°˜ ON{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-comments"></i> ìš°ë¦¬ë°˜ ì‹¤ì‹œê°„ ì±„íŒ…</h5>
                <small>ëª¨ë“  ëŒ€í™”ëŠ” ì €ì¥ë˜ë‹ˆ ì˜ˆì˜ë¥¼ ì§€ì¼œì£¼ì„¸ìš” ğŸ˜Š</small>
            </div>
            <div class="card-body">
                <div id="messages" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 10px; padding: 15px; background: #f8f9fa;">
                    {% for message in messages %}
                    <div class="message-item mb-2">
                        <strong class="text-primary">{{ message[0] }}:</strong>
                        <span>{{ message[1] }}</span>
                        <small class="text-muted d-block">{{ message[2] }}</small>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="input-group mt-3">
                    <input type="text" id="messageInput" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500">
                    <button class="btn btn-primary" type="button" id="sendBtn">
                        <i class="fas fa-paper-plane"></i> ì „ì†¡
                    </button>
                </div>
                
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        í˜„ì¬ ì ‘ì†ì: <span id="userCount">1</span>ëª…
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const socket = io();
    const messages = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    
    // ë°© ì°¸ì—¬
    socket.emit('join', {});
    
    // ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
            socket.emit('message', {message: message});
            messageInput.value = '';
        }
    }
    
    sendBtn.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // ë©”ì‹œì§€ ìˆ˜ì‹ 
    socket.on('message', function(data) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-item mb-2';
        
        if (data.username === 'System') {
            messageDiv.innerHTML = `
                <span class="text-info"><i class="fas fa-info-circle"></i> ${data.message}</span>
            `;
        } else {
            messageDiv.innerHTML = `
                <strong class="text-primary">${data.username}:</strong>
                <span>${data.message}</span>
                <small class="text-muted d-block">${data.timestamp || 'just now'}</small>
            `;
        }
        
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
        
        // ë©”ì‹œì§€ê°€ ë„ˆë¬´ ë§ì•„ì§€ë©´ ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ
        if (messages.children.length > 100) {
            messages.removeChild(messages.firstChild);
        }
    });
    
    // í˜ì´ì§€ ë¡œë“œì‹œ ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
    window.addEventListener('load', function() {
        messages.scrollTop = messages.scrollHeight;
    });
    
    // í˜ì´ì§€ ë– ë‚  ë•Œ ë°© ë‚˜ê°€ê¸°
    window.addEventListener('beforeunload', function() {
        socket.emit('leave', {});
    });
</script>
{% endblock %}